<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mkit-idv</title>
    <link href="/style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="app()" class="bg-dark text-white min-h-screen">

    <!-- Header + Tab Bar -->
    <header class="bg-darker border-b border-white/10 sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto px-6 flex items-center justify-between h-14">
            <h1 class="text-lg font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">mkit-idv</h1>
            <nav class="flex gap-1">
                <button @click="tab='servers'" :class="tab==='servers' ? 'tab-active' : 'tab-inactive'" class="tab-item">Servers</button>
                <button @click="tab='accounts'" :class="tab==='accounts' ? 'tab-active' : 'tab-inactive'" class="tab-item">Accounts</button>
                <button @click="tab='bindings'" :class="tab==='bindings' ? 'tab-active' : 'tab-inactive'" class="tab-item">Bindings & Transactions</button>
            </nav>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto p-6">

        <!-- ==================== TAB: SERVERS ==================== -->
        <div x-show="tab==='servers'" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Servers</h2>
                <button @click="showServerModal=true" class="btn-primary btn-sm">+ Add Server</button>
            </div>
            <div class="card overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="th">ID</th><th class="th">Base URL</th><th class="th">Port</th><th class="th">Description</th><th class="th">Status</th><th class="th">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="s in servers" :key="s.id">
                            <tr class="tr">
                                <td class="td" x-text="s.id"></td>
                                <td class="td font-mono text-xs" x-text="s.base_url"></td>
                                <td class="td" x-text="s.port"></td>
                                <td class="td" x-text="s.description || '-'"></td>
                                <td class="td"><span :class="s.is_active ? 'badge-success' : 'badge-error'" x-text="s.is_active ? 'Active' : 'Off'"></span></td>
                                <td class="td">
                                    <button @click="toggleServerStatus(s.id, !s.is_active)" class="link-btn">Toggle</button>
                                    <button @click="deleteServer(s.id)" class="link-btn text-red-400">Del</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="servers.length===0"><td colspan="6" class="td text-center text-slate-500 py-6">No servers</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ==================== TAB: ACCOUNTS ==================== -->
        <div x-show="tab==='accounts'" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Accounts</h2>
                <div class="flex gap-2">
                    <button @click="showAccountBulkModal=true" class="btn-secondary btn-sm">+ Bulk Import</button>
                    <button @click="showAccountModal=true" class="btn-primary btn-sm">+ Add Account</button>
                </div>
            </div>
            <div class="card overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="th">ID</th><th class="th">MSISDN</th><th class="th">Email</th><th class="th">Batch</th><th class="th">Balance</th><th class="th">Status</th><th class="th">Reseller</th><th class="th">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="a in accounts" :key="a.id">
                            <tr class="tr">
                                <td class="td" x-text="a.id"></td>
                                <td class="td font-mono" x-text="a.msisdn"></td>
                                <td class="td text-xs" x-text="a.email"></td>
                                <td class="td text-xs" x-text="a.batch_id"></td>
                                <td class="td" x-text="fmtBal(a.balance_last)"></td>
                                <td class="td"><span :class="{'badge-success': a.status==='ACTIVE','badge-warning': a.status==='EXHAUSTED','badge-error': a.status==='BANNED','badge-gray': a.status==='NEW'}" x-text="a.status"></span></td>
                                <td class="td"><span :class="a.is_reseller ? 'badge-success' : 'badge-gray'" x-text="a.is_reseller ? 'Yes' : 'No'"></span></td>
                                <td class="td"><button @click="deleteAccount(a.id)" class="link-btn text-red-400">Del</button></td>
                            </tr>
                        </template>
                        <tr x-show="accounts.length===0"><td colspan="8" class="td text-center text-slate-500 py-6">No accounts</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ==================== TAB: BINDINGS & TRANSACTIONS ==================== -->
        <div x-show="tab==='bindings'" class="space-y-6">

            <!-- Bindings: Command Center -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Active Bindings</h2>
                    <button @click="showBindingModal=true" class="btn-primary btn-sm">+ New Binding</button>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="th">ID</th><th class="th">Server</th><th class="th">Account</th><th class="th">Step</th><th class="th">Balance</th><th class="th">Reseller</th><th class="th min-w-[320px]">Controls</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="b in bindings" :key="b.id">
                                <tr class="tr" :class="{'opacity-40': b.step==='LOGGED_OUT', 'border-l-2 border-l-primary': getBindingControl(b)==='processing' || getBindingControl(b)==='needs-trx-otp'}">
                                    <td class="td" x-text="b.id"></td>
                                    <td class="td text-xs" x-text="getServerPort(b.server_id)"></td>
                                    <td class="td font-mono text-xs" x-text="getMsisdn(b.account_id)"></td>
                                    <td class="td">
                                        <span :class="{
                                            'badge-gray': b.step==='BOUND',
                                            'badge-info': b.step==='OTP_REQUESTED' || b.step==='OTP_VERIFICATION' || b.step==='OTP_VERIFIED',
                                            'badge-success': b.step==='TOKEN_LOGIN_FETCHED',
                                            'badge-error': b.step==='LOGGED_OUT'
                                        }" x-text="b.step"></span>
                                    </td>
                                    <td class="td" x-text="fmtBal(b.balance_last)"></td>
                                    <td class="td"><span :class="b.is_reseller ? 'badge-success' : 'badge-gray'" x-text="b.is_reseller ? 'Yes' : 'No'"></span></td>
                                    <td class="td">
                                        <!-- CONTROLS: needs-verify -->
                                        <div x-show="getBindingControl(b)==='needs-verify'" class="flex items-center gap-2">
                                            <input type="text" x-model="getBS(b.id).verifyOtp" placeholder="OTP" class="inline-input w-24">
                                            <input type="text" x-model="getBS(b.id).verifyPin" placeholder="PIN" class="inline-input w-20">
                                            <button @click="verifyLogin(b.id)" :disabled="getBS(b.id).loading" class="btn-primary btn-xs">Verify</button>
                                            <button @click="deleteBinding(b.id)" class="link-btn text-red-400 text-xs">Del</button>
                                        </div>

                                        <!-- CONTROLS: verifying -->
                                        <div x-show="getBindingControl(b)==='verifying'" class="flex items-center gap-2 text-blue-400">
                                            <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                                            <span class="text-xs">Verifying...</span>
                                        </div>

                                        <!-- CONTROLS: ready (no active trx) -->
                                        <div x-show="getBindingControl(b)==='ready'" class="flex items-center gap-2 relative">
                                            <button @click="getBS(b.id).showStartTrx = !getBS(b.id).showStartTrx" class="btn-primary btn-xs">Start Trx</button>
                                            <button @click="logoutBinding(b.id)" class="btn-xs btn-secondary">Logout</button>
                                            <button @click="deleteBinding(b.id)" class="link-btn text-red-400 text-xs">Del</button>
                                            <!-- Start Trx Popover -->
                                            <div x-show="getBS(b.id).showStartTrx" @click.outside="getBS(b.id).showStartTrx=false" class="popover">
                                                <div class="text-xs font-semibold mb-2 text-slate-400">Start Transaction</div>
                                                <div class="space-y-2">
                                                    <input type="text" x-model="getBS(b.id).trxProductId" placeholder="Product ID" class="inline-input w-full">
                                                    <input type="email" x-model="getBS(b.id).trxEmail" placeholder="Email" class="inline-input w-full">
                                                    <input type="number" x-model="getBS(b.id).trxLimitHarga" placeholder="Limit Harga" class="inline-input w-full">
                                                    <button @click="startTransaction(b.id)" :disabled="getBS(b.id).loading" class="btn-primary btn-xs w-full">Start</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- CONTROLS: needs-trx-otp -->
                                        <div x-show="getBindingControl(b)==='needs-trx-otp'" class="flex items-center gap-2">
                                            <span class="text-xs text-yellow-400">OTP Required</span>
                                            <input type="text" x-model="getBS(b.id).trxOtp" placeholder="OTP" class="inline-input w-24">
                                            <button @click="submitTrxOtp(b.id)" :disabled="getBS(b.id).loading" class="btn-primary btn-xs">Submit</button>
                                            <button @click="pauseTransaction(b.id)" class="btn-xs btn-secondary">Pause</button>
                                            <button @click="stopTransaction(b.id)" class="btn-xs btn-danger">Stop</button>
                                        </div>

                                        <!-- CONTROLS: processing -->
                                        <div x-show="getBindingControl(b)==='processing'" class="flex items-center gap-2">
                                            <span class="text-xs text-blue-400">Processing...</span>
                                            <button @click="continueTransaction(b.id)" class="btn-xs btn-secondary">Continue</button>
                                            <button @click="pauseTransaction(b.id)" class="btn-xs btn-secondary">Pause</button>
                                            <button @click="stopTransaction(b.id)" class="btn-xs btn-danger">Stop</button>
                                            <button @click="checkBalance(b.id)" class="link-btn text-blue-400 text-xs">Bal</button>
                                        </div>

                                        <!-- CONTROLS: paused -->
                                        <div x-show="getBindingControl(b)==='paused'" class="flex items-center gap-2">
                                            <span class="text-xs text-yellow-400">Paused</span>
                                            <button @click="resumeTransaction(b.id)" class="btn-xs btn-primary">Resume</button>
                                            <button @click="stopTransaction(b.id)" class="btn-xs btn-danger">Stop</button>
                                        </div>

                                        <!-- CONTROLS: logged-out -->
                                        <div x-show="getBindingControl(b)==='logged-out'" class="flex items-center gap-2">
                                            <span class="text-xs text-slate-500">Logged out</span>
                                            <button @click="deleteBinding(b.id)" class="link-btn text-red-400 text-xs">Del</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="bindings.length===0"><td colspan="7" class="td text-center text-slate-500 py-6">No bindings. Create one to start.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction Log -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Transaction Log</h2>
                    <button @click="loadTransactions()" class="btn-secondary btn-xs">Refresh</button>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="th">ID</th><th class="th">Binding</th><th class="th">Product</th><th class="th">Amount</th><th class="th">Status</th><th class="th">OTP</th><th class="th">Voucher</th><th class="th">Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="t in transactions.slice().reverse()" :key="t.id">
                                <tr class="tr">
                                    <td class="td" x-text="t.id"></td>
                                    <td class="td" x-text="'#' + t.binding_id"></td>
                                    <td class="td" x-text="t.product_id || '-'"></td>
                                    <td class="td" x-text="fmtBal(t.amount)"></td>
                                    <td class="td">
                                        <span :class="{
                                            'badge-gray': t.status==='CREATED',
                                            'badge-info': t.status==='PROCESSING' || t.status==='RESUMED',
                                            'badge-warning': t.status==='PAUSED' || t.status==='SUSPECT',
                                            'badge-success': t.status==='SUKSES',
                                            'badge-error': t.status==='GAGAL'
                                        }" x-text="t.status"></span>
                                    </td>
                                    <td class="td">
                                        <span x-show="t.otp_status" :class="{
                                            'badge-warning': t.otp_status==='PENDING',
                                            'badge-success': t.otp_status==='SUCCESS',
                                            'badge-error': t.otp_status==='FAILED'
                                        }" x-text="t.otp_status" class="text-xs"></span>
                                        <span x-show="!t.otp_status" class="text-slate-500">-</span>
                                    </td>
                                    <td class="td">
                                        <span x-show="t.voucher_code" class="font-mono text-xs text-green-400" x-text="t.voucher_code"></span>
                                        <span x-show="!t.voucher_code" class="text-slate-500">-</span>
                                    </td>
                                    <td class="td text-xs text-slate-400" x-text="fmtTime(t.created_at)"></td>
                                </tr>
                            </template>
                            <tr x-show="transactions.length===0"><td colspan="8" class="td text-center text-slate-500 py-6">No transactions yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== MODALS ==================== -->

    <!-- Server Modal -->
    <div x-show="showServerModal" class="modal" @click.self="showServerModal=false">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Add Server</h3>
            <form @submit.prevent="createServer" class="space-y-3">
                <div><label class="label">Base URL</label><input type="text" x-model="serverForm.base_url" class="input-field" placeholder="http://localhost:9900" required></div>
                <div><label class="label">Port</label><input type="number" x-model="serverForm.port" class="input-field" placeholder="9900" required></div>
                <div><label class="label">Description</label><input type="text" x-model="serverForm.description" class="input-field" placeholder="myim3 Bot #1"></div>
                <div class="flex gap-2 justify-end"><button type="button" @click="showServerModal=false" class="btn-secondary btn-sm">Cancel</button><button type="submit" class="btn-primary btn-sm">Create</button></div>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div x-show="showAccountModal" class="modal" @click.self="showAccountModal=false">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Add Account</h3>
            <form @submit.prevent="createAccount" class="space-y-3">
                <div><label class="label">MSISDN</label><input type="text" x-model="accountForm.msisdn" class="input-field" placeholder="085777076575" required></div>
                <div><label class="label">Email</label><input type="email" x-model="accountForm.email" class="input-field" placeholder="user@example.com" required></div>
                <div><label class="label">Batch ID</label><input type="text" x-model="accountForm.batch_id" class="input-field" placeholder="batch-2026-02-11" required></div>
                <div><label class="label">PIN</label><input type="text" x-model="accountForm.pin" class="input-field" placeholder="1234"></div>
                <div class="flex gap-2 justify-end"><button type="button" @click="showAccountModal=false" class="btn-secondary btn-sm">Cancel</button><button type="submit" class="btn-primary btn-sm">Create</button></div>
            </form>
        </div>
    </div>

    <!-- Account Bulk Modal -->
    <div x-show="showAccountBulkModal" class="modal" @click.self="showAccountBulkModal=false">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Bulk Import</h3>
            <form @submit.prevent="createAccountsBulk" class="space-y-3">
                <div><label class="label">MSISDNs (one per line)</label><textarea x-model="accountBulkForm.msisdns_text" class="input-field" rows="5" placeholder="085777076575&#10;08156142731" required></textarea></div>
                <div><label class="label">Email</label><input type="email" x-model="accountBulkForm.email" class="input-field" placeholder="user@example.com" required></div>
                <div><label class="label">Batch ID</label><input type="text" x-model="accountBulkForm.batch_id" class="input-field" placeholder="batch-2026-02-11" required></div>
                <div class="flex gap-2 justify-end"><button type="button" @click="showAccountBulkModal=false" class="btn-secondary btn-sm">Cancel</button><button type="submit" class="btn-primary btn-sm">Import</button></div>
            </form>
        </div>
    </div>

    <!-- Binding Modal -->
    <div x-show="showBindingModal" class="modal" @click.self="showBindingModal=false">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">New Binding</h3>
            <form @submit.prevent="createBinding" class="space-y-3">
                <div>
                    <label class="label">Server</label>
                    <select x-model="bindingForm.server_id" class="input-field" required>
                        <option value="">Select server</option>
                        <template x-for="s in servers.filter(s => s.is_active)" :key="s.id"><option :value="s.id" x-text="s.base_url + ' - ' + (s.description || 'No desc')"></option></template>
                    </select>
                </div>
                <div>
                    <label class="label">Account</label>
                    <select x-model="bindingForm.account_id" class="input-field" required>
                        <option value="">Select account</option>
                        <template x-for="a in accounts" :key="a.id"><option :value="a.id" x-text="a.msisdn + ' (' + a.email + ')'"></option></template>
                    </select>
                </div>
                <div class="flex gap-2 justify-end"><button type="button" @click="showBindingModal=false" class="btn-secondary btn-sm">Cancel</button><button type="submit" class="btn-primary btn-sm">Create</button></div>
            </form>
        </div>
    </div>

    <script src="/app.js"></script>
</body>
</html>
