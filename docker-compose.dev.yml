services:
  redis:
    image: redis:7-alpine
    container_name: mkit-idv-redis-dev
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    networks:
      - mkit-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mkit-idv-app-dev
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "app.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "9914",
        "--reload",
      ]
    ports:
      - "9914:9914"
    environment:
      PYTHONUNBUFFERED: "1"
      WATCHFILES_FORCE_POLLING: "true"
      WATCHFILES_POLL_DELAY_MS: "300"
      REDIS__URL: "redis://redis:6379/0"
    volumes:
      - ./backend/app:/app/app:cached
      - ./backend/mlog.yaml:/app/mlog.yaml:ro
      - ./backend/logs:/app/logs
      - ./application.db:/app/application.db
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9914/health')",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - mkit-network

  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mkit-idv-orchestrator-dev
    command: ["uv", "run", "python", "-m", "app.orchestrator_main"]
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS__URL: "redis://redis:6379/0"
    volumes:
      - ./backend/app:/app/app:cached
      - ./backend/mlog.yaml:/app/mlog.yaml:ro
      - ./backend/logs:/app/logs
      - ./application.db:/app/application.db
    depends_on:
      - redis
    networks:
      - mkit-network

  frontend:
    image: node:20-alpine
    container_name: mkit-idv-frontend-dev
    working_dir: /workspace/frontend
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0 --port 5173"]
    environment:
      VITE_PROXY_TARGET: "http://app:9914"
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "300"
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/workspace/frontend:cached
      - frontend_node_modules:/workspace/frontend/node_modules
    depends_on:
      - app
      - orchestrator
    networks:
      - mkit-network

networks:
  mkit-network:
    driver: bridge

volumes:
  frontend_node_modules:
    driver: local
